{% extends 'base.html' %} {% block content %}

<main id="main" class="main">
  <!-- Título -->
  <div class="pagetitle">
    <h1>Dashboard Chamado</h1>
    <nav>
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'telaIni' %}">Home</a></li>
        <li class="breadcrumb-item">Prontoticket</li>
        <li class="breadcrumb-item active">Dashboard Chamado</li>
      </ol>
    </nav>
  </div>
  <!-- Título -->

  <!-- Corpo -->
  <section class="section dashboard">
    <div class="col-xxl-4 col-xl-12">
      <div class="card info-card revenue-card">
        <div class="filter">
          <a class="icon" href="#" data-bs-toggle="dropdown"><i class="bi bi-three-dots"></i></a>
          <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
            <li class="dropdown-header text-start">
              <h6>Filter</h6>
            </li>
            <li><a class="dropdown-item" href="#">Today</a></li>
            <li><a class="dropdown-item" href="#">This Month</a></li>
            <li><a class="dropdown-item" href="#">This Year</a></li>
          </ul>
        </div>
        <div class="card-body">
          <h5 class="card-title">Indicadores<span>| Chamados</span></h5>
          <div class="d-flex align-items-center">
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-clipboard-plus"></i>
            </div>
            <div class="ps-3">
              <h6>{{aber}}</h6>
              <span class="text-muted small pt-2 ps-1">Chamados Abertos</span>
            </div>
            <div class="col-md-1">
            </div>
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-people"></i>
            </div>
            <div class="ps-3">
              <h6>{{prog}}</h6>
              <span class="text-muted small pt-2 ps-1">Chamados em Atendimento</span>
            </div>
            <div class="col-md-1">
            </div>
            <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
              <i class="bi bi-clipboard"></i>
            </div>
            <div class="ps-3">
              <h6>{{geralCnt}}</h6>
              <span class="text-muted small pt-2 ps-1">Total de chamados</span>
            </div>
            <div class="col-md-1">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Problemas frequentes -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Divisão por frequência</h5>
          <canvas id="probFreq" style="max-height: 30vw;"></canvas>
        </div>
      </div>
    </div>


    <!-- <div class="row">
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Pie Chart</h5>
            <canvas id="divStatus" style="max-height: 400px;"></canvas>
          </div>
        </div>
      </div> -->

      <!-- <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Pie Chart</h5>
            <canvas id="divStatus" style="max-height: 400px;"></canvas>
          </div>
        </div>
      </div>
    </div> -->

    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Column Chart</h5>
          <div id="columnChart"></div>
        </div>
      </div>
    </div>
        
        

        

    



    <!-- <div class="container">
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Divisão por setor</h5>
              <div id="barChart"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Status</h5>
              <div id="lineChart"></div>
            </div>
          </div>
        </div>
      </div>
    </div> -->
    <input type="text" value="{{setores}}" id="setoresJson" hidden>
  </section>
  <!-- Corpo -->
</main>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    echarts
      .init(document.querySelector("#divStatus"))
      .setOption({
        tooltip: {
          trigger: "item",
        },
        series: [
          {
            name: "Estado do chamado:",
            type: "pie",
            radius: "70%",
            data: [
              {
                value: "{{aber}}",
                name: "Aberto",
              },
              {
                value: "{{prog}}",
                name: "Andamento",
              },
              {
                value: "{{vali}}",
                name: "Validação",
              },
              {
                value: "{{agen}}",
                name: "Agendado",
              },
              {
                value: "{{escl}}",
                name: "Esclarecimento",
              },
            ],
            emphasis: {
              itemStyle: {
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowColor: "rgba(0, 0, 0, 0.5)",
              },
            },
          },
        ],
      });
  });

  var id
  var setorName
  var setorList = []
  var chamadoSetorQnt = []
  jsonMes = chamadoMes('{{ chamadoPmes }}')
  console.log(jsonMes)

  
  
  /* for (var key in dictCnt) {
    var value = dictCnt[key];

    for (var i = 0; i < setorData.length; i++) {
      var item = setorData[i];
      var id = item.id
      var setor = item.name

      if (id == 2 || id == 3 || id == 23 || id == 24) {
        if(id == key){
          setorList.push(setor)
          chamadoSetorQnt.push(value)
        }
      } 
    }
  }
  console.log(setorList)
  console.log(chamadoSetorQnt)  */

  document.addEventListener("DOMContentLoaded", () => {
    new Chart(document.querySelector('#probFreq'), {
      type: 'bar',
      data: {
        labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
        datasets: [{
          label: 'Bar Chart',
          data: [jsonMes[0], jsonMes[1], jsonMes[2], jsonMes[3], jsonMes[4], jsonMes[5], jsonMes[6], jsonMes[7], jsonMes[8], jsonMes[9], jsonMes[10], jsonMes[11]],
          backgroundColor: [
            'rgba(255, 99, 132, 0.2)',
            'rgba(255, 159, 64, 0.2)',
            'rgba(255, 205, 86, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(54, 162, 235, 0.2)',
            'rgba(153, 102, 255, 0.2)',
            'rgba(201, 203, 207, 0.2)'
          ],
          borderColor: [
            'rgb(255, 99, 132)',
            'rgb(255, 159, 64)',
            'rgb(255, 205, 86)',
            'rgb(75, 192, 192)',
            'rgb(54, 162, 235)',
            'rgb(153, 102, 255)',
            'rgb(201, 203, 207)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  });

  
  

  /* var id 
  var setorName 
  var setorList = []
  var chamadoSetorQnt = []
  setorData = cleanString('setoresJson');
  dictCnt = cleanDict('{{ chamadoSetor }}');

  for (var key in dictCnt) {
    var value = dictCnt[key];

    for (var i = 0; i < setorData.length; i++) {
      var item = setorData[i];
      var id = item.id
      var setor = item.name

      if (id == 2 || id == 3 || id == 23 || id == 24) {
        if(id == key){
          setorList.push(setor)
          chamadoSetorQnt.push(value)
        }
      } 
    }
  }
  /* console.log(setorList)
  console.log(chamadoSetorQnt) */
 

  /* document.addEventListener("DOMContentLoaded", () => {
    new ApexCharts(document.querySelector("#barChart"), {
      series: [{
        data: chamadoSetorQnt
      }],
      chart: {
        type: 'bar',
        height: 200
      },
      plotOptions: {
        bar: {
          borderRadius: 4,
          horizontal: true,
        }
      },
      dataLabels: {
        enabled: false
      },
      xaxis: {
        categories: setorList,
      }
    }).render();
  }); */ 

  document.addEventListener("DOMContentLoaded", () => {
    new ApexCharts(document.querySelector("#columnChart"), {
      series: [{
        name: 'Net Profit',
        data: [44, 55, 57, 56, 61, 58, 63, 60, 66]
      }, {
        name: 'Revenue',
        data: [76, 85, 101, 98, 87, 105, 91, 114, 94]
      }, {
        name: 'Free Cash Flow',
        data: [35, 41, 36, 26, 45, 48, 52, 53, 41]
      }],
      chart: {
        type: 'bar',
        height: 350
      },
      plotOptions: {
        bar: {
          horizontal: false,
          columnWidth: '55%',
          endingShape: 'rounded'
        },
      },
      dataLabels: {
        enabled: false
      },
      stroke: {
        show: true,
        width: 2,
        colors: ['transparent']
      },
      xaxis: {
        categories: ['Setor1', 'Setor1', 'Setor1', 'Setor1', 'Setor1', 'Setor1', 'Setor1', 'Setor1', 'Setor1'],
      },
      yaxis: {
        title: {
          text: '$ (thousands)'
        }
      },
      fill: {
        opacity: 1
      },
      tooltip: {
        y: {
          formatter: function(val) {
            return "$ " + val + " thousands"
          }
        }
      }
    }).render();
  });




function cleanString(elementId) {
  // Troca os none da string para null e aspas simples '' para aspas duplas ""
  // Transforma string em json para manipulação
  var inputElement = document.getElementById(elementId);
  var data = inputElement.value;
  var cleanedString = data.replace(/'/g, '"');
  var cleanedString = data.replace(/None/g, 'null').replace(/'/g, '"');
  data = JSON.parse(cleanedString)
  return data
}

function cleanDict(dict) {
  var chamadoSetorString = dict
  var jsonFormatado = chamadoSetorString.substring(1, chamadoSetorString.length - 1);
  var chaveValor = jsonFormatado.split(',');
  var chamadoSetorJson = {};

  chaveValor.forEach(function(pair) {
    var [key, value] = pair.split(':');
    chamadoSetorJson[key.trim()] = parseInt(value.trim());
  });
  return chamadoSetorJson
}

function chamadoMes(json) {
  var divProvisoria = document.createElement('div');
  divProvisoria.innerHTML = json;
  var jsonMes = divProvisoria.innerText;
  jsonMes = JSON.parse(jsonMes);

  var array = new Array(12).fill(0);

  for(var i = 0; i < jsonMes.length; i++) {
    var item = jsonMes[i];
    var ano = item.year
    //TODO: Criar if de acordo com o ano,  
    var mes = item.month
    var qnt = item.count

    array[mes] = qnt
   // console.log(mes, qnt, ano)
  }
  //console.log(array) 



  return array
}
</script>

{% endblock %}
